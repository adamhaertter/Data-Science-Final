---
title: "Final Project Work"
author: "Adam Haertter & Brennan Mulligan"
format: html
---

# Initial Steps

```{r lib}
#| message: false
#| echo: false

library("tidyverse")
library("rvest")
library("magrittr")
library("here")
```

## Scraping Data

See our [Python scraper](scripts/scrape_vgchartz.py). VGChartz renders its data through a JavaScript table, so the data itself is not accessible through the native HTML for R scraping.

## Wrangling Data

See [wrangle_data.R](scripts/wrangle_data.R).

> You shouldn't need to run this line unless the `data/wrangled/` dir is empty.

```{r}
source("scripts/wrangle_data.R")
```

## Loading Data into Environment

Rerun this if you need to reset the master table. The dataframe with all info is called `master`

```{r}
load(file = here("data", "wrangled", "wrangled_data.rda"))
```

# Data Analysis

Most popular genres by publisher.

```{r}
#master %>% group_by(Publisher, Genre) %>% 
#  summarize("sum" = sum(Total.Sales)) %>% 
#  drop_na() %>% arrange(sum) %>%
#  filter(sum > 0.00) 

publishers_by_sales <- master[, c(3,5,8)]  %>% drop_na() %>%
  group_by(Publisher.Simple) %>% summarize("Sum.Sales" = sum(Total.Sales)) %>% arrange(desc(Sum.Sales))

# It appears our biggest publishers are Nintendo, Electronic Arts, Activision Blizzard, Ubisoft, and Sony
# Since they are our most successful companies, let's look into what genre is their most successful by sales

publisher_by_genre <- function(publisher) {
  master[, c(3,4,5,8)] %>%
  filter(Console != "Series" & Console != "All" & Publisher.Simple == publisher) %>%
  drop_na() %>%
  group_by(Genre) %>% summarize("Sum.Sales" = sum(Total.Sales)) %>% arrange(desc(Sum.Sales))
}

sales_by_genre_plot <- function(publisher) {
  ggplot(publisher_by_genre(publisher), aes(x = reorder(Genre, -Sum.Sales), y = Sum.Sales, fill = Genre)) + geom_bar(stat = "identity", position = position_dodge()) + theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x = "Genre", y = "Sales", title = paste(publisher, " Sales By Genre")) + scale_fill_discrete(guide="none")
}

sales_by_genre_plot("Nintendo")
sales_by_genre_plot("Electronic Arts")
sales_by_genre_plot("Activision Blizzard")
sales_by_genre_plot("Ubisoft")
sales_by_genre_plot("Sony")

# Most popular genres
ggplot(as.data.frame(sort(table(master$Genre)), decreasing = TRUE), aes(x = reorder(Var1, -Freq), y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(x = "Genre", y = "Games Published", title = "Most Popular Genres") +
  scale_fill_discrete(guide="none")

# Highest Selling Genres
genres_by_sales <- master[, c(3,4,5,8)]  %>% drop_na() %>%
  group_by(Genre) %>% summarize("Sum.Sales" = sum(Total.Sales)) %>% arrange(desc(Sum.Sales))

ggplot(genres_by_sales, aes(x = reorder(Genre, -Sum.Sales), y = Sum.Sales, fill = Genre)) +
  geom_bar(stat = "identity") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(x = "Genre", y = "Sales", title = "Highest Selling Genres") +
  scale_fill_discrete(guide="none")

# Highest Selling Genre By Publisher
genre_counter <- data.frame(Sales = integer(), Genre = character(), 
                            stringsAsFactors = FALSE)
publisher_size <- length(publishers_by_sales$Publisher.Simple)
for(i in 1:publisher_size) {
  genre_counter <- 
    data.frame(lapply(genre_counter,as.character),stringsAsFactors = FALSE)
  genre_counter <- 
    rbind(genre_counter,c(publisher_by_genre(publishers_by_sales$Publisher.Simple[i])$Genre[1], publisher_by_genre(publishers_by_sales$Publisher.Simple[i])$Sum.Sales[1]))
}

colnames(genre_counter) <- c("Genre", "Sales")
genre_counter %<>% drop_na()

ggplot(genre_counter, aes(x = Genre, y = Sales, fill = Genre)) +
  geom_bar(stat = "identity") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(x = "Genre", y = "Amount of Publishers", title = "Highest Selling Genres By Publisher") +
  scale_fill_discrete(guide="none")
```

Which genre gets the most support on each console?

```{r}
consoles_by_genres <- master %>%
  group_by(Console, Genre) %>%
  filter(Console %in% c("XB", "PS2", "DS", "3DS", "Wii", "NS", "PS3", "PS4", "X360", "XOne", "PSP", "WiiU", "And", "Mobile")) %>%
  filter(Genre != "Misc") %>%
  summarize(Genre.Amount = n()) %>%
  arrange(desc(Genre.Amount)) %>%
  ungroup() %>%
  complete(Console, Genre, fill = list(Genre.Amount = 0)) %>% 
  replace_na(list(Genre.Amount = 0))


ggplot(consoles_by_genres, aes(x = Console, y = Genre, fill = Genre.Amount)) +
  geom_tile() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_fill_gradient2(low = "white", mid = "green", high = "darkgreen", midpoint = 250) +
  labs(x = "Consoles", 
       y = "Genres", 
       fill = "Genres", 
       title = "Heatmap of Most Supported Genre on Each Console")
```

On which consoles do publishers get the most sales?

```{r}
theme_set(theme_classic())

console_by_publisher_sales <- master %>% 
  group_by(Console, Publisher.Simple) %>% .[, c("Console", "Publisher.Simple", "Total.Sales")] %>%
  drop_na() %>% 
  filter(Publisher.Simple %in% c("Nintendo", "Electronic Arts", "Activision Blizzard", "Sony", "Ubisoft", "Bandai Namco", "THQ", "Sega", "Square Enix", "Konami")) %>% # Top 10 publishers
  filter(Console %in% c("PC", "XB", "PS2", "DS", "3DS", "Wii", "NS", "PS3", "PS4", "PS5", "X360", "XOne", "XS", "PSP", "WiiU", "And", "Mobile")) %>%
  summarize("Sum.Sales" = sum(Total.Sales), .groups = "drop") %>% ungroup() %>% complete(Console, Publisher.Simple, fill = list(Sum.Sales = 0)) %>% 
  replace_na(list(Sum.Sales = 0)) 

ggplot(console_by_publisher_sales, aes(x = Console, y = Publisher.Simple, fill = Sum.Sales)) +
  geom_tile() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_fill_gradient2(low = "white", mid = "magenta", high = "purple", midpoint = 225, na.value = "white") + 
  labs(x = "Console", 
       y = "Publisher", 
       fill = "Total Sales", 
       title = "Heatmap of Best-Performing Console Releases by Publisher")
```

On which consoles do publishers produce the most games?

```{r}

```
